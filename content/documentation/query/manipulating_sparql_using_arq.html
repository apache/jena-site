<!DOCTYPE html>
<html lang="en">
<head>
    

    <title>Apache Jena - Tutorial - Manipulating SPARQL using ARQ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/css/bootstrap-extension.css" rel="stylesheet" type="text/css">
    <link href="/css/jena.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="/images/favicon.ico" />

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
    <script src="/js/jena-navigation.js" type="text/javascript"></script>
    <script src="/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/js/breadcrumbs.js" type="text/javascript"></script>

    <script src="/js/improve.js" type="text/javascript"></script>

    
</head>

<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/index.html">
                <img class="logo-menu" src="/images/jena-logo/jena-logo-notext-small.png" alt="jena logo">Apache Jena</a>
        </div>

        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                <li id="homepage"><a href="/index.html"><span class="glyphicon glyphicon-home"></span> Home</a></li>
                <li id="download"><a href="/download/index.cgi"><span class="glyphicon glyphicon-download-alt"></span> Download</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-book"></span> Learn <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-header">Tutorials</li>
                        <li><a href="/tutorials/index.html">Overview</a></li>
                        <li><a href="/tutorials/rdf_api.html">RDF core API tutorial</a></li>
                        <li><a href="/tutorials/sparql.html">SPARQL tutorial</a></li>
                        <li><a href="/documentation/query/manipulating_sparql_using_arq.html">Manipulating SPARQL using ARQ</a></li>
                        <li><a href="/tutorials/using_jena_with_eclipse.html">Using Jena with Eclipse</a></li>
                        <li><a href="/documentation/notes/index.html">How-To's</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">References</li>
                        <li><a href="/documentation/index.html">Overview</a></li>
                        <li><a href="/documentation/javadoc.html">Javadoc</a></li>
                        <li><a href="/documentation/rdf/index.html">RDF API</a></li>
                        <li><a href="/documentation/io/">RDF I/O</a></li>
                        <li><a href="/documentation/query/index.html">ARQ (SPARQL)</a></li>
                        <li><a href="/documentation/rdfconnection/">RDF Connection - SPARQL API</a></li>
                        <li><a href="/documentation/tdb/index.html">TDB</a></li>
                        <li><a href="/documentation/tdb2/index.html">TDB2</a></li>
                        <li><a href="/documentation/query/text-query.html">Text Search</a></li>
                        <li><a href="/documentation/shacl/index.html">SHACL</a></li>
                        <li><a href="/documentation/geosparql/index.html">GeoSPARQL</a></li>
                        <li><a href="/documentation/tools/index.html">Command-line tools</a></li>
                        <li><a href="/documentation/hadoop/index.html">Elephas - tools for RDF on Hadoop</a></li>
                        <li><a href="/documentation/jdbc/index.html">SPARQL over JDBC</a></li>
                        <li><a href="/documentation/fuseki2/index.html">Fuseki</a></li>
                        <li><a href="/documentation/permissions/index.html">Permissions</a></li>
                        <li><a href="/documentation/assembler/index.html">Assembler</a></li>
                        <li><a href="/documentation/ontology/">Ontology API</a></li>
                        <li><a href="/documentation/inference/index.html">Inference API</a></li>
                        <li><a href="/documentation/extras/querybuilder/index.html">Query Builder</a></li>
                    </ul>
                </li>

                <li class="drop down">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-book"></span> Javadoc <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/documentation/javadoc/jena/">Jena Core</a></li>
                        <li><a href="/documentation/javadoc/arq/">ARQ</a></li>
                        <li><a href="/documentation/javadoc/tdb/">TDB</a></li>
                        <li><a href="/documentation/javadoc/fuseki2/">Fuseki</a></li>
                        <li><a href="/documentation/javadoc_elephas.html">Elephas</a></li>
                        <li><a href="/documentation/javadoc/text/">Text Search</a></li>
                        <li><a href="/documentation/javadoc/shacl/">SHACL</a></li>
                        <li><a href="/documentation/javadoc/geosparql/">GeoSPARQL</a></li>
                        <li><a href="/documentation/javadoc/permissions/">Permissions</a></li>
                        <li><a href="/documentation/javadoc/jdbc/">JDBC</a></li>
                        <li><a href="/documentation/javadoc/extras/querybuilder/">Query Builder</a></li>
                        <li><a href="/documentation/javadoc/">All Javadoc</a></li>
                    </ul>
                </li>

                <li id="ask"><a href="/help_and_support/index.html"><span class="glyphicon glyphicon-question-sign"></span> Ask</a></li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-bullhorn"></span> Get involved <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/getting_involved/index.html">Contribute</a></li>
                        <li><a href="/help_and_support/bugs_and_suggestions.html">Report a bug</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Project</li>
                        <li><a href="/about_jena/about.html">About Jena</a></li>
                        <li><a href="/about_jena/roadmap.html">Roadmap</a></li>
                        <li><a href="/about_jena/architecture.html">Architecture</a></li>
                        <li><a href="/about_jena/team.html">Project team</a></li>
                        <li><a href="/about_jena/contributions.html">Related projects</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">ASF</li>
                        <li><a href="http://www.apache.org/">Apache Software Foundation</a></li>
                        <li><a href="http://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                        <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
                        <li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li>
                        <li><a href="http://www.apache.org/security/">Security</a></li>
                    </ul>
                </li>

                <li id="edit"><a href="https://github.com/apache/jena-site/edit/master/source/documentation/query/manipulating_sparql_using_arq.md" title="Edit this page on GitHub"><span class="glyphicon glyphicon-pencil"></span> Edit this page</a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div id="breadcrumbs"></div>
            <h1 class="title">Tutorial - Manipulating SPARQL using ARQ</h1>
            
	<p>When you&rsquo;ve been working with SPARQL you quickly find that static
queries are restrictive. Maybe you want to vary a value, perhaps add a
filter, alter the limit, etc etc. Being an impatient sort you dive in to
the query string, and it works. But what about <a href="http://xkcd.com/327/">little Bobby
Tables</a>? And, even if you
sanitise your inputs, string manipulation is a fraught process and
syntax errors await you. Although it might seem harder than string
munging, the ARQ API is your friend in the long run.</p>
<p><em>Originally published on the <a href="https://web.archive.org/web/20151107135044/http://researchrevealed.ilrt.bris.ac.uk/?p=35">Research Revealed project
blog</a></em></p>
<h2 id="inserting-values-simple-prepared-statements">Inserting values (simple prepared statements)</h2>
<p>Let&rsquo;s begin with something simple. Suppose we wanted to restrict the
following query to a particular person:</p>
<pre><code>   select * { ?person &lt;http://xmlns.com/foaf/0.1/name&gt; ?name }
</code></pre>
<p><code>String#replaceAll</code> would work, but there is a safer way.
<code>QueryExecutionFactory</code> in most cases lets you supply a <code>QuerySolution</code>
with which you can prebind values.</p>
<pre><code>   QuerySolutionMap initialBinding = new QuerySolutionMap();
   initialBinding.add(&quot;name&quot;, personResource);
   qe = QueryExecutionFactory.create(query, dataset, initialBinding);
</code></pre>
<p>This is often much simpler than the string equivalent since you don&rsquo;t
have to escape quotes in literals. (Beware that this doesn&rsquo;t work for
<code>sparqlService</code>, which is a great shame. It would be nice to spend some
time remedying that.)</p>
<h2 id="making-a-query-from-scratch">Making a Query from Scratch</h2>
<p>The previously mentioned limitation is due to the fact that prebinding
doesn&rsquo;t actually change the query at all, but the execution of that
query. So what how do we really alter queries?</p>
<p>ARQ provides two ways to work with queries: at the syntax level (<code>Query</code>
and <code>Element</code>), or the algebra level (<code>Op</code>). The distinction is clear in
filters:</p>
<pre><code>   SELECT ?s { ?s &lt;http://example.com/val&gt; ?val . FILTER ( ?val &lt; 20 ) }
</code></pre>
<p>If you work at the syntax level you&rsquo;ll find that this looks (in pseudo
code) like:</p>
<pre><code>   (GROUP (PATTERN ( ?s &lt;http://example.com/val&gt; ?val )) (FILTER ( &lt; ?val 20 ) ))
</code></pre>
<p>That is there&rsquo;s a group containing a triple pattern and a filter, just
as you see in the query. The algebra is different, and we can see it
using <code>arq.qparse --print op</code></p>
<pre><code>   $ java arq.qparse --print op 'SELECT ?s { ?s &lt;http://example.com/val&gt; ?val . FILTER ( ?val &lt; 20 ) }'
   (base &lt;file:///...&gt;
       (project (?s)
           (filter (&lt; ?val 20)
               (bgp (triple ?s &lt;http://example.com/val&gt; ?val)))))
</code></pre>
<p>Here the filter contains the pattern, rather than sitting next to it.
This form makes it clear that the expression is filtering the pattern.</p>
<p>Let&rsquo;s create that query from scratch using ARQ. We begin with some
common pieces: the triple to match, and the expression for the filter.</p>
<pre><code>   // ?s ?p ?o .
   Triple pattern =
       Triple.create(Var.alloc(&quot;s&quot;), Var.alloc(&quot;p&quot;), Var.alloc(&quot;o&quot;));
   // ( ?s &lt; 20 )
   Expr e = new E_LessThan(new ExprVar(&quot;s&quot;), new NodeValueInteger(20));
</code></pre>
<p><code>Triple</code> should be familiar from jena. <code>Var</code> is an extension of <code>Node</code>
for variables. <code>Expr</code> is the root interface for expressions, those
things that appear in <code>FILTER</code> and <code>LET</code>.</p>
<p>First the syntax route:</p>
<pre><code>   ElementTriplesBlock block = new ElementTriplesBlock(); // Make a BGP
   block.addTriple(pattern);                              // Add our pattern match
   ElementFilter filter = new ElementFilter(e);           // Make a filter matching the expression
   ElementGroup body = new ElementGroup();                // Group our pattern match and filter
   body.addElement(block);
   body.addElement(filter);

   Query q = QueryFactory.make();
   q.setQueryPattern(body);                               // Set the body of the query to our group
   q.setQuerySelectType();                                // Make it a select query
   q.addResultVar(&quot;s&quot;);                                   // Select ?s
</code></pre>
<p>Now the algebra:</p>
<pre><code>   Op op;
   BasicPattern pat = new BasicPattern();                 // Make a pattern
   pat.add(pattern);                                      // Add our pattern match
   op = new OpBGP(pat);                                   // Make a BGP from this pattern
   op = OpFilter.filter(e, op);                           // Filter that pattern with our expression
   op = new OpProject(op, Arrays.asList(Var.alloc(&quot;s&quot;))); // Reduce to just ?s
   Query q = OpAsQuery.asQuery(op);                       // Convert to a query
   q.setQuerySelectType();                                // Make is a select query
</code></pre>
<p>Notice that the query form (<code>SELECT, CONSTRUCT, DESCRIBE, ASK</code>) isn&rsquo;t
part of the algebra, and we have to set this in the query (although
SELECT is the default). <code>FROM</code> and <code>FROM NAMED</code> are similarly absent.</p>
<h2 id="navigating-and-tinkering-visitors">Navigating and Tinkering: Visitors</h2>
<p>You can also look around the algebra and syntax using visitors. Start by
extending <code>OpVisitorBase</code> (<code>ElementVisitorBase</code>) which stubs out the
interface so you can concentrate on the parts of interest, then walk
using <code>OpWalker.walk(Op, OpVisitor)</code>
(<code>ElementWalker.walk(Element, ElementVisitor)</code>). These work bottom up.</p>
<p>For some alterations, like manipulating triple matches in place,
visitors will do the trick. They provide a simple way to get to the
right parts of the query, and you can alter the pattern backing BGPs in
both the algebra and syntax. Mutation isn&rsquo;t consistently available,
however, so don&rsquo;t depend on it.</p>
<h2 id="transforming-the-algebra">Transforming the Algebra</h2>
<p>So far there is no obvious advantage in using the algebra. The real
power is visible in transformers, which allow you to reorganise an
algebra completely. ARQ makes extensive use of transformations to
simplify and optimise query execution.</p>
<p>In Research Revealed I wrote some code to take a number of constraints
and produce a query. There were a number of ways to do this, but one way
I found was to generate ops from each constraint and join the results:</p>
<pre><code>   for (Constraint con: cons) {
       op = OpJoin.create(op, consToOp(cons)); // join
   }
</code></pre>
<p>The result was a perfectly correct mess, which is only barely readable
with just three conditions:</p>
<pre><code>   (join
       (join
           (filter (&lt; ?o0 20) (bgp (triple ?s &lt;urn:ex:prop0&gt; ?o0)))
           (filter (&lt; ?o1 20) (bgp (triple ?s &lt;urn:ex:prop1&gt; ?o1))))
       (filter (&lt; ?o2 20) (bgp (triple ?s &lt;urn:ex:prop2&gt; ?o2))))
</code></pre>
<p>Each of the constraints is a filter on a bgp. This can be made much more
readable by moving the filters out, and merging the triple patterns. We
can do this with the following <code>Transform</code>:</p>
<pre><code>   class QueryCleaner extends TransformBase
   {
       @Override
       public Op transform(OpJoin join, Op left, Op right) {
           // Bail if not of the right form
           if (!(left instanceof OpFilter &amp;&amp; right instanceof OpFilter)) return join;
           OpFilter leftF = (OpFilter) left;
           OpFilter rightF = (OpFilter) right;

           // Add all of the triple matches to the LHS BGP
           ((OpBGP) leftF.getSubOp()).getPattern().addAll(((OpBGP) rightF.getSubOp()).getPattern());
           // Add the RHS filter to the LHS
           leftF.getExprs().addAll(rightF.getExprs());
           return leftF;
       }
   }
   ...
   op = Transformer.transform(new QueryCleaner(), op); // clean query
</code></pre>
<p>This looks for joins of the form:</p>
<pre><code>   (join
       (filter (exp1) (bgp1))
       (filter (exp2) (bgp2)))
</code></pre>
<p>And replaces it with:</p>
<pre><code>   (filter (exp1 &amp;&amp; exp2) (bgp1 &amp;&amp; bgp2))
</code></pre>
<p>As we go through the original query all joins are removed, and the
result is:</p>
<pre><code>   (filter (exprlist (&lt; ?o0 20) (&lt; ?o1 20) (&lt; ?o2 20))
       (bgp
           (triple ?s &lt;urn:ex:prop0&gt; ?o0)
           (triple ?s &lt;urn:ex:prop1&gt; ?o1)
           (triple ?s &lt;urn:ex:prop2&gt; ?o2)
   ))
</code></pre>
<p>That completes this brief introduction. There is much more to ARQ, of
course, but hopefully you now have a taste for what it can do.</p>


        </div>
    </div>

</div>

<footer class="footer">
    <div class="container">
        <p>
            Copyright &copy; 2011&ndash;2020 The Apache Software Foundation, Licensed under the
            <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        </p>
        <p>
            Apache Jena, Jena, the Apache Jena project logo, Apache and the Apache feather logos are trademarks of
            The Apache Software Foundation.
        </p>
    </div>
</footer>


<script type="text/javascript">
    var link = $('a[href="' + this.location.pathname + '"]');
    if (link != undefined)
        link.parents('li,ul').addClass('active');
</script>

</body>
</html>
